this.MyOD&&"object"==typeof this.MyOD||(this.MyOD={}),function(){"use strict";MyOD=new Backbone.Marionette.Application,MyOD.on("before:start",function(){this.searchModel=new MyOD.Models.SearchModel,this.layout=new MyOD.Main.Layout}),MyOD.on("start",function(){Backbone.history&&(Backbone.history.start({pushState:!1,root:"/OpenData-Backbone"})||MyOD.navigate("404",{trigger:!0})),Backbone.history.on("route",this.layout.setClasses),this.layout.setClasses()}),MyOD.navigate=function(e,t){Backbone.history.navigate(e,t)},MyOD.search=function(){var e=MyOD.searchModel.getRoute();MyOD.navigate(e,{trigger:!0})},MyOD.navigate404=function(){MyOD.navigate("404",{trigger:!0,replace:!0})},MyOD.queryStringToObject=function(){var e={},t=Backbone.history.getFragment().split("?")[1];if(t){var i=t.split("&");_.each(i,function(t){t=t.split("="),e[t[0]]="q"===t[0]?t[1].replace(/\+/g," ")||"":decodeURIComponent(t[1]||"")})}return e},MyOD.getBloodhound=function(){return this.bloodhound||(this.bloodhound=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.obj.whitespace("value"),queryTokenizer:Bloodhound.tokenizers.whitespace,limit:10,remote:{url:MyOD.config.api+"datasets/autocomplete.json?query=%QUERY",rateLimitWait:150,replace:function(e,t){return e.replace("%QUERY",t)},filter:function(e){return e.data}}})),this.bloodhound},MyOD.onBeforeDestroy=function(){Backbone.history.stop()}}(),function(){"use strict";MyOD.module("Utils",function(e,t,i,o,a,n){e.MapManager=o.Object.extend({initialize:function(){n.bindAll(this,"updateStyle"),this.globalChannel=i.Wreqr.radio.channel("global");var e=a.Deferred();this.dojoReady=e.promise(),require(["esri/map","esri/layers/FeatureLayer","plugins/smartMapping","dojo/domReady!"],function(){e.resolve()}),t.reqres.setHandler("smaps:update:style",this.updateStyle)},onBeforeDestroy:function(){this.map&&this.map.destroy()},proxyEvent:function(e,t){this.globalChannel.vent.trigger(e,t)},createMap:function(e,t){var i={center:[-56.049,38.485],zoom:3,basemap:"dark-gray"};if(this.map=new esri.Map(e,i),t.coords){var o=new esri.geometry.Extent(t.coords[0][0],t.coords[0][1],t.coords[1][0],t.coords[1][1],new esri.SpatialReference({wkid:4326}));this.map.setExtent(o)}this.map.on("load",dojo.hitch(this,this.proxyEvent,"map:load")),this.map.on("extent-change",dojo.hitch(this,this.proxyEvent,"map:extent-change")),this.map.on("layer-add",dojo.hitch(this,this.proxyEvent,"map:layer-add"))},getDatasetInfoTemplate:function(e){var t=e.get("display_field");return new esri.InfoTemplate("${"+t+"}","${*}")},getDatasetLayerOpts:function(e){return{mode:esri.layers.FeatureLayer.MODE_AUTO,outFields:"*",infoTemplate:this.getDatasetInfoTemplate(e)}},addDataset:function(e){var t=this.getDatasetLayerOpts(e);this.datasetLayer=new esri.layers.FeatureLayer(e.get("url"),t),this.datasetLayer.on("load",this.onLoadDataset),this.datasetLayer.on("load",dojo.hitch(this,this.proxyEvent,"map:datasetlayer:load")),this.datasetLayer.on("click",dojo.hitch(this,this.proxyEvent,"map:datasetlayer:click")),this.datasetLayer.on("query-limit-exceeded",dojo.hitch(this,this.proxyEvent,"map:datasetlayer:query-limit-exceeded")),this.datasetLayer.on("update-end",dojo.hitch(this,this.proxyEvent,"map:datasetlayer:update-end")),this.map.addLayer(this.datasetLayer)},onLoadDataset:function(e){e.layer.minScale=0,e.layer.maxScale=0},updateStyle:function(e){var t=a.Deferred(),i=e.layer=this.datasetLayer,o=function(o){i.setRenderer(o.renderer),i.graphics&&i.graphics.length&&(i.graphics[0].attributes[e.field]?i.redraw():i.refresh()),t.resolve(o.renderer)};return"polygon"===e.type?esri.renderer.smartMapping.createClassedColorRenderer(e).then(function(e){o(e)}):"point"!==e.type||e.heatmap?"point"===e.type&&e.heatmap&&esri.renderer.smartMapping.createHeatmapRenderer(e).then(function(e){o(e)}):esri.renderer.smartMapping.createClassedSizeRenderer(e).then(function(e){o(e)}),t.promise()}})})}(),function(){"use strict";MyOD.module("Base",function(e,t,i,o){e.SearchView=o.ItemView.extend({onRender:function(){this.initTypeahead()},initTypeahead:function(){var e={highlight:!0,minLength:3,hint:!1},i=t.getBloodhound();i.initialize();var o={name:"datasets",displayKey:function(e){return e},templates:{empty:""},source:i.ttAdapter()};this.ui.search.typeahead(e,o)},onTypeaheadSelected:function(){this.model.set({q:this.ui.search.typeahead("val"),page:1}),this.search()},updateModel:function(){var e=this.ui.search.typeahead("val");this.model.set({q:e,page:1})},onKeyDown:function(e){13===e.which&&(e.preventDefault(),this.updateModel(),this.search())},onKeyUp:function(){this.updateModel()},search:function(){t.search()}})})}(),function(){"use strict";MyOD.module("Models",function(e,t,i,o,a,n){e.SearchModel=i.Model.extend({defaults:{q:"",page:1,per_page:20,total_count:0,sort_by:"relevance"},queryStringParams:["q","page","per_page","sort_by"],getRoute:function(e){var t=n.pick(this.toJSON(),this.queryStringParams),i="datasets";return i+=e?".json?":"?",i+=a.param(t)},getUrl:function(){return t.config.api+this.getRoute(!0)}})})}(),MyOD.config={api:"//opendata.arcgis.com/"},function(){"use strict";MyOD.module("Main",function(e){e.HeaderSearchView=MyOD.Base.SearchView.extend({initialize:function(){this.listenTo(this.model,"change:q",this.onQueryChanged)},el:"#header-search-container",template:!1,events:{"keydown #header-search":"onKeyDown","keyup #header-search":"onKeyUp","click #header-search-btn":"search","typeahead:selected input":"onTypeaheadSelected"},ui:{search:"#header-search"},onQueryChanged:function(){this.ui.search.typeahead("val",this.model.get("q"))}})})}(),function(){"use strict";MyOD.module("Main",function(e,t,i,o,a,n){e.Layout=o.LayoutView.extend({initialize:function(){n.bindAll(this,"setClasses"),this.headerSearchView=new e.HeaderSearchView({model:t.searchModel}).render()},el:"body",regions:{main:"#main-region"},events:{"click #home-link":"navigateHome"},navigateHome:function(e){e.metaKey||e.ctrlKey||(e.preventDefault(),t.navigate("",{trigger:!0}))},setClasses:function(){var e=this;0===i.history.getFragment().indexOf("datasets")?e.$el.removeClass("page-home"):e.$el.addClass("page-home")}})})}(),function(){"use strict";MyOD.module("HomeModule",function(e,t){e.View=MyOD.Base.SearchView.extend({initialize:function(){this.model=t.searchModel},template:JST["home/templates/home"],events:{"keydown #search":"onKeyDown","keyup #search":"onKeyUp","click #search-btn":"search","typeahead:selected input":"onTypeaheadSelected"},ui:{search:"#search"},id:"home",onDomRefresh:function(){this.ui.search.focus()}})})}(),function(){"use strict";MyOD.module("HomeModule",function(e,t,i,o){e.Controller=o.Controller.extend({initUi:function(){var i=new e.View;t.layout.getRegion("main").show(i)}})})}(),function(){"use strict";MyOD.module("HomeModule",function(e,t,i){e.Router=i.Marionette.AppRouter.extend({appRoutes:{"":"show"}}),e.addInitializer(function(){new e.Router({controller:e.API})}),e.API={show:function(t){this.homeController||(this.homeController=new e.Controller(t)),this.homeController.initUi(t)}}})}(),function(){"use strict";MyOD.module("Models",function(e,t,i,o,a,n){e.DatasetModel=i.Model.extend({initialize:function(){this.on("sync",this.onSync)},defaults:{id:"",name:"",description:"",tags:[],arcgis_online_item_url:"",owner:"",url:"",created_at:"",updated_at:"",views:0,thumbnail_url:""},parse:function(e){var t=e.data||e;return t},url:function(){return MyOD.config.api+"datasets/"+this.get("id")+".json"},getNumericFields:function(){var e=this.get("fields");return n.filter(e,function(e){return n.contains(["esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeInteger"],e.type)})}})})}(),function(){"use strict";MyOD.module("Models",function(e,t,i,o,a,n){e.DatasetCollection=i.Collection.extend({model:e.DatasetModel,url:function(){return t.searchModel.getUrl(!0)},parse:function(e){return t.searchModel.set(n.extend(e.metadata.query_parameters,e.metadata.stats)),e.data}})})}(),function(){"use strict";MyOD.module("ResultsModule",function(e,t,i,o,a){e.ItemView=o.ItemView.extend({template:JST["results/templates/results-item"],model:MyOD.Models.DatasetModel,tagName:"tr",events:{click:"onClick"},onClick:function(){this.trigger("result:clicked",this.model)}}),e.LoadingView=o.ItemView.extend({template:JST["results/templates/results-loading"],tagName:"tr",className:"loading"}),e.EmptyView=o.ItemView.extend({template:JST["results/templates/results-empty"],tagName:"tr"}),e.View=o.CompositeView.extend({initialize:function(){this.listenTo(this,"childview:result:clicked",this.selectDataset)},collectionIsLoading:!0,template:JST["results/templates/results"],childView:e.ItemView,childViewContainer:"tbody",getEmptyView:function(){return this.collectionIsLoading?e.LoadingView:e.EmptyView},events:{"click ul.pagination a":"onPageClicked"},modelEvents:{"change:total_count":"render"},collectionEvents:{sync:"onCollectionSync",error:"onCollectionSync"},id:"page-results",onCollectionSync:function(){this.collectionIsLoading=!1,this.render()},selectDataset:function(e,i){t.navigate("/datasets/"+i.get("id"),{trigger:!0})},onPageClicked:function(e){if(!e.metaKey&&!e.ctrlKey){e.stopPropagation(),e.preventDefault();var i=a(e.target).closest("a").data("page");this.model.set("page",i),t.search()}},templateHelpers:function(){for(var e,i=t.searchModel.toJSON(),o=Math.round(i.total_count),a=+i.page,n=0===a?a+1:a,s=i.per_page,r=Math.ceil(o/s),l=[],c=r>10&&n>6?n-5:1,d=r>c+9?c+9:r,u=this.model.clone(),h=c;d>=h;h++)e=h===n?"active":"",u.set("page",h),l.push({url:u.getRoute(!1),page:h,active:e});var p=this.model.getRoute(!1),m=a;1!==n&&(m=a-1,u.set("page",m),p=u.getUrl());var y=this.model.getRoute(!1),g=a;return r!==n&&(g=a+1,u.set("page",g),y=u.getUrl()),{firstPage:1===n?"disabled":"",lastPage:r===n?"disabled":"",prevUrl:p,nextUrl:y,prevPage:m,nextPage:g,pages:l,collectionIsLoading:this.collectionIsLoading}}})})}(),function(){"use strict";MyOD.module("ResultsModule",function(e,t,i,o){e.Controller=o.Controller.extend({initUi:function(){this.collection=new t.Models.DatasetCollection,this.collection.fetch({cache:!0}),this.view=new e.View({model:t.searchModel,collection:this.collection}),t.layout.getRegion("main").show(this.view)}})})}(),function(){"use strict";MyOD.module("ResultsModule",function(e,t,i){e.Router=i.Marionette.AppRouter.extend({appRoutes:{"datasets(/)":"show"}}),e.addInitializer(function(){new e.Router({controller:e.API})}),e.API={show:function(i){var o=t.queryStringToObject();t.searchModel.set(o),this.resultsController||(this.resultsController=new e.Controller(i)),this.resultsController.initUi(i)}}})}(),function(){"use strict";MyOD.module("Models",function(e,t,i){e.DatasetRow=i.Model.extend({})})}(),function(){"use strict";MyOD.module("Models",function(e,t,i,o,a,n){e.RowCollection=i.Collection.extend({initialize:function(e,t){this.dataset=t.dataset;var i=this.dataset.get("advanced_query_capabilities");this.supportsPagination=i&&i.supportsPagination,i&&!n.isUndefined(i.supports_pagination)&&window.alert("The API has been fixed. Time to update /entities/row-collection.js!"),this.orderBy=this.dataset.get("object_id_field")},perPage:10,page:0,orderBy:"",orderByAsc:!0,model:e.DatasetRow,getQueryUrl:function(){var e=this.dataset.get("url");e+="/query?where=1%3D1&text=&objectIds=&time=&geometry=&geometryType=esriGeometryEnvelope&inSR=&spatialRel=esriSpatialRelIntersects&relationParam=&outFields=*&returnGeometry=false&maxAllowableOffset=&geometryPrecision=&outSR=&returnIdsOnly=false&returnCountOnly=false&groupByFieldsForStatistics=&outStatistics=&returnZ=false&returnM=false&gdbVersion=&returnDistinctValues=false&f=pjson",this.supportsPagination&&(e+="&resultOffset="+this.page*this.perPage,e+="&resultRecordCount="+this.perPage);var t=this.orderBy;return this.orderByAsc||(t+=" desc"),e+="&orderByFields="+t},url:function(){return this.getQueryUrl()},parse:function(e){var t=e.features;return this.supportsPagination||(t=n.first(t,this.perPage)),t}})})}(),function(){"use strict";MyOD.module("DatasetsModule",function(e,t,i,o,a){e.TableRowView=o.ItemView.extend({initialize:function(e){this.dataset=e.dataset,this.fields=this.dataset.get("fields")},template:JST["datasets/templates/table-row"],templateHelpers:function(){var e=this;return{fields:e.fields}},model:MyOD.Models.DatasetRow,tagName:"tr"}),e.TableView=o.CompositeView.extend({initialize:function(){this.collection=new t.Models.RowCollection([],{dataset:this.model}),this.collection.fetch()},events:{"click ul.pagination li a":"onPageClicked","click thead th":"sort"},collectionEvents:{reset:"render"},template:JST["datasets/templates/table"],childView:e.TableRowView,childViewOptions:function(){var e=this.model;return{dataset:e}},templateHelpers:function(){var e={firstPage:"",lastPage:"",prevPage:0,nextPage:0,pages:[],showPagination:!1,from:1,to:this.collection.perPage,total:this.model.get("record_count"),sortField:this.collection.orderBy,sortClass:this.collection.orderByAsc?"sort_asc":"sort_desc",sortIconClass:this.collection.orderByAsc?"glyphicon-arrow-down":"glyphicon-arrow-up"};if(this.collection.supportsPagination){for(var t,i=Math.ceil(this.model.get("record_count")/this.collection.perPage),o=this.collection.page,a=i>10&&o>6?o-5:1,n=i>a+9?a+9:i,s=[],r=a;n>=r;r++)t=r===o+1?"active":"",s.push({page:r,active:t});var l=this.model.get("record_count"),c=o*this.collection.perPage+1,d=o*this.collection.perPage+this.collection.perPage;d=l>=d?d:l,e={firstPage:0===o?"disabled":"",lastPage:i===o+1?"disabled":"",prevPage:o,nextPage:o+2,pages:s,showPagination:!0,from:c,to:d,total:l,sortField:this.collection.orderBy,sortClass:this.collection.orderByAsc?"sort_asc":"sort_desc",sortIconClass:this.collection.orderByAsc?"glyphicon-chevron-down":"glyphicon-chevron-up"}}return e},childViewContainer:"tbody",onPageClicked:function(e){var t=a(e.target).closest("a"),i=t.closest("li");if(!i.hasClass("disabled")&&!i.hasClass("active")){var o=t.data("page")-1;this.collection.page=o,this.collection.fetch({reset:!0})}},sort:function(e){var t=a(e.target).data("fieldName");t&&(this.collection.orderByAsc=t===this.collection.orderBy?!this.collection.orderByAsc:!0,this.collection.page=0,this.collection.orderBy=t,this.collection.fetch({reset:!0}))}})})}(),function(){"use strict";MyOD.module("DatasetsModule",function(e,t,i,o,a,n){e.View=o.ItemView.extend({initialize:function(e){n.bindAll(this,"changeAttribute","changeRamp"),this.mapManager=e.mapManager},template:JST["datasets/templates/dataset"],id:"page-dataset",ui:{mapDiv:"#map",tableContainer:"#table-container"},modelEvents:{change:"render"},templateHelpers:function(){var e=this.model.url().replace(/.json$/,"");return{baseUrl:e}},onRender:function(){this.tableView=new e.TableView({el:this.ui.tableContainer,model:this.model}).render()},onDomRefresh:function(){if("table"!==this.model.get("layer_type").toLowerCase()){var e=this;this.ui.mapDiv.show(),this.mapManager.dojoReady.done(function(){e.mapManager.createMap("map",{coords:e.model.get("extent").coordinates}),e.mapManager.addDataset(e.model),e.initSmaps()})}},initSmaps:function(){var e=this.model.getNumericFields();if(e.length){this.fieldName=this.fieldName||e[0].name;var t=this.model.get("fields");this.stats=this.getStats(t,this.fieldName),this.type=this.getGeometryType(this.model.get("geometry_type"));var i={fields:e,field:this.fieldName,statistics:this.stats,type:this.type,schemes:this.getSchemes()};this.yuki?(a("#yuki-viz-tools").remove(),this.yuki=new Yuki("smaps",i)):this.yuki=new Yuki("smaps",i),this.yuki.on("change",this.changeAttribute),this.yuki.on("ramp-change",this.changeRamp),this._execStyleMap()}},getStats:function(e,t){var i=n.findWhere(e,{name:t});return i?i.statistics:null},getGeometryType:function(e){switch(e){case"esriGeometryPoint":case"esriGeometryMultipoint":return"point";case"esriGeometryPolyline":return"line";case"esriGeometryPolygon":return"polygon";default:return e.toLowerCase()}},getSchemes:function(){var e,t,i=this;switch(this.type){case"point":e="default",t="size";break;case"polygon":e="high-to-low",t="choropleth"}return esri.styles[t].getSchemes({theme:e,basemap:"dark-gray",geometryType:i.type})},changeAttribute:function(e){var t=this.model.get("fields");this.stats=this.getStats(t,e),this.fieldName=e,this._execStyleMap(this.selectedScheme)},changeRamp:function(e){this.selectedScheme=this.getSchemes().secondarySchemes[e],this._execStyleMap(this.selectedScheme)},_execStyleMap:function(e){var i=this,o={field:this.fieldName,basemap:"dark-gray",statistics:this.stats,type:this.type};e&&(o.scheme=e);t.reqres.request("smaps:update:style",o).done(function(e){"point"===i.type&&i.yuki.buildPointLegend(e.breaks)})},onDestroy:function(){this.mapManager.destroy(),this.tableView.destroy()}})})}(),function(){"use strict";MyOD.module("DatasetsModule",function(e,t,i,o,a,n){e.Controller=o.Controller.extend({initialize:function(){n.bindAll(this,"onModelFetched")},initUi:function(e){this.mapManager=new t.Utils.MapManager,this.model=new t.Models.DatasetModel({id:e}),this.model.fetch().done(this.onModelFetched).fail(function(){t.navigate404()})},onModelFetched:function(){var i=new e.View({model:this.model,mapManager:this.mapManager});t.layout.getRegion("main").show(i)},onBeforeDestroy:function(){this.mapManager&&this.mapManager.destroy()}})})}(),function(){"use strict";MyOD.module("DatasetsModule",function(e,t,i){e.Router=i.Marionette.AppRouter.extend({appRoutes:{"datasets/:id(/)":"show"}}),e.addInitializer(function(){new e.Router({controller:e.API})}),e.API={show:function(t){this.datasetsController||(this.datasetsController=new e.Controller(t)),this.datasetsController.initUi(t)}}})}(),function(){"use strict";MyOD.module("ErrorModule",function(e,t,i,o){e.View=o.ItemView.extend({id:"page-error",getTemplate:function(){var e,t=this.model.get("errorCode");switch(t){case 404:e=JST["error/templates/404"];break;default:e=JST["error/templates/500"]}return e}})})}(),function(){"use strict";MyOD.module("ErrorModule",function(e,t,i,o){e.Controller=o.Controller.extend({initUi:function(o){var a=new i.Model({errorCode:o.errorCode}),n=new e.View({model:a});t.layout.getRegion("main").show(n)}})})}(),function(){"use strict";MyOD.module("ErrorModule",function(e,t,i){e.Router=i.Marionette.AppRouter.extend({appRoutes:{404:"error404",500:"error500"}}),e.addInitializer(function(){new e.Router({controller:e.API})}),e.API={initController:function(){this.errorController||(this.errorController=new e.Controller)},error404:function(){this.initController(),this.errorController.initUi({errorCode:404})},error500:function(){this.initController(),this.errorController.initUi({errorCode:500})}}})}(),$(function(){"use strict";MyOD.start()});
//# sourceMappingURL=../maps/scripts/main.js.map