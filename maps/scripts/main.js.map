{"version":3,"sources":["scripts/main.js"],"names":["this","MyOD","Backbone","Marionette","Application","on","searchModel","Models","SearchModel","layout","Main","Layout","history","start","pushState","root","navigate","trigger","setClasses","route","options","search","getRoute","navigate404","replace","queryStringToObject","result","q","getFragment","split","pairs","_","each","pair","decodeURIComponent","getBloodhound","bloodhound","Bloodhound","datumTokenizer","tokenizers","obj","whitespace","queryTokenizer","limit","remote","url","config","api","rateLimitWait","query","filter","response","data","onBeforeDestroy","stop","module","Utils","App","$","MapManager","Object","extend","initialize","bindAll","globalChannel","Wreqr","radio","channel","dfd","Deferred","dojoReady","promise","require","resolve","reqres","setHandler","updateStyle","map","destroy","proxyEvent","evtName","evt","vent","createMap","mapDiv","mapOpts","center","zoom","basemap","esri","Map","coords","extent","geometry","Extent","SpatialReference","wkid","setExtent","dojo","hitch","getDatasetInfoTemplate","dataset","displayFieldName","get","InfoTemplate","getDatasetLayerOpts","mode","layers","FeatureLayer","MODE_AUTO","outFields","infoTemplate","addDataset","opts","datasetLayer","onLoadDataset","addLayer","layer","minScale","maxScale","_applyRenderer","smap","setRenderer","renderer","graphics","length","attributes","field","redraw","refresh","type","smartMapping","createClassedColorRenderer","then","heatmap","createHeatmapRenderer","createClassedSizeRenderer","Base","SearchView","ItemView","onRender","initTypeahead","highlight","minLength","hint","datasets","name","displayKey","item","templates","empty","source","ttAdapter","ui","typeahead","onTypeaheadSelected","model","set","page","updateModel","onKeyDown","e","which","preventDefault","onKeyUp","Model","defaults","per_page","total_count","sort_by","queryStringParams","pick","toJSON","param","getUrl","HeaderSearchView","listenTo","onQueryChanged","el","template","events","keydown #header-search","keyup #header-search","click #header-search-btn","typeahead:selected input","LayoutView","headerSearchView","render","regions","main","click #home-link","navigateHome","metaKey","ctrlKey","self","indexOf","$el","removeClass","addClass","HomeModule","View","JST","keydown #search","keyup #search","click #search-btn","id","onDomRefresh","focus","Controller","initUi","view","getRegion","show","Router","AppRouter","appRoutes","addInitializer","controller","API","homeController","DatasetModel","onSync","description","tags","arcgis_online_item_url","owner","created_at","updated_at","views","thumbnail_url","parse","getNumericFields","fields","contains","DatasetCollection","Collection","resp","metadata","query_parameters","stats","ResultsModule","tagName","click","onClick","LoadingView","className","EmptyView","CompositeView","selectDataset","collectionIsLoading","childView","childViewContainer","getEmptyView","click ul.pagination a","modelEvents","change:total_count","collectionEvents","sync","error","onCollectionSync","childModel","onPageClicked","stopPropagation","target","closest","templateHelpers","active","info","len","Math","round","from","size","total_pages","ceil","pages","end","clone","i","push","prevUrl","prevPage","nextUrl","nextPage","firstPage","lastPage","collection","fetch","cache","datasets(/)","queryObj","resultsController","DatasetRow","RowCollection","queryCapabilities","supportsPagination","isUndefined","supports_pagination","window","alert","orderBy","perPage","orderByAsc","getQueryUrl","rows","features","first","DatasetsModule","TableRowView","TableView","click ul.pagination li a","click thead th","reset","childViewOptions","showPagination","to","total","sortField","sortClass","sortIconClass","totalPages","anchor","li","hasClass","sort","mapManager","tableContainer","change","baseUrl","tableView","toLowerCase","done","coordinates","initSmaps","numerics","fieldName","getStats","getGeometryType","yukiOptions","statistics","schemes","getSchemes","yuki","remove","Yuki","changeAttribute","changeRamp","_execStyleMap","fieldObj","findWhere","geomType","theme","styleType","styles","geometryType","selectedScheme","index","secondarySchemes","scheme","request","buildPointLegend","breaks","onDestroy","onModelFetched","fail","datasets/:id(/)","datasetsController","ErrorModule","getTemplate","errorCode","404","500","initController","errorController","error404","error500"],"mappings":"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","file":"scripts/main.js","sourcesContent":["/*jshint -W020 */\n\nif (!this.MyOD || typeof this.MyOD !== 'object') {\n  this.MyOD = {};\n}\n\n(function () {\n  'use strict';\n\n  MyOD = new Backbone.Marionette.Application();\n\n  MyOD.on('before:start', function(options){\n    this.searchModel = new MyOD.Models.SearchModel();\n    this.layout = new MyOD.Main.Layout();\n    //this.reqres = new Backbone.Wreqr.RequestResponse();\n  });\n\n  MyOD.on('start', function(options){\n    if (Backbone.history){\n      //if you are hosting on a server that can let the browser handle all the routing,\n      //you can use pushstate, otherwise (gh-pages) use hashed urls\n      //Backbone.history.start({ pushState: Modernizr.history, root: '/OpenData-Backbone' });\n      if (!Backbone.history.start({ pushState: false, root: '/OpenData-Backbone' })) {\n        MyOD.navigate('404', { trigger:true });\n      }\n    }\n\n    Backbone.history.on('route', this.layout.setClasses);\n    this.layout.setClasses();\n  });\n\n  MyOD.navigate = function (route, options) {\n    Backbone.history.navigate(route, options);\n  };\n\n  MyOD.search = function (options) {\n    var route = MyOD.searchModel.getRoute();\n    MyOD.navigate(route, { trigger:true });\n  };\n\n  MyOD.navigate404 = function () {\n    MyOD.navigate('404', { trigger: true, replace: true });\n  };\n\n  MyOD.queryStringToObject = function () {\n    var result = {};\n\n    var q = Backbone.history.getFragment().split('?')[1];\n\n    if (q) {\n      var pairs = q.split('&');\n      \n      _.each(pairs, function(pair) {\n        pair = pair.split('=');\n        if (pair[0] === 'q') {\n          result[pair[0]] = pair[1].replace(/\\+/g, ' ') || '';\n        } else {\n          result[pair[0]] = decodeURIComponent(pair[1] || '');\n        }\n      });\n    }\n\n    return result;\n  };\n\n  MyOD.getBloodhound = function () {\n    if (!this.bloodhound) {\n      this.bloodhound = new Bloodhound({\n        datumTokenizer: Bloodhound.tokenizers.obj.whitespace('value'),\n        queryTokenizer: Bloodhound.tokenizers.whitespace,\n        limit: 10,\n        remote: {\n          url: MyOD.config.api + 'datasets/autocomplete.json?query=%QUERY',\n          rateLimitWait: 150,\n          replace: function (url, query) {\n            return url.replace('%QUERY', query);\n          },\n          filter: function(response) {\n            return response.data;\n          }\n        }\n      });\n    }\n    return this.bloodhound;\n  };\n\n  MyOD.onBeforeDestroy = function () {\n    Backbone.history.stop();\n  };\n\n})();\n\n(function () {\n    \n  'use strict';\n\n  MyOD.module('Utils', function (Utils, App, Backbone, Marionette, $, _) {\n\n    Utils.MapManager = Marionette.Object.extend({\n      \n      initialize: function () {\n        _.bindAll(this, 'updateStyle');\n\n        this.globalChannel = Backbone.Wreqr.radio.channel('global');\n\n        var dfd = $.Deferred();\n        this.dojoReady = dfd.promise();\n        require(['esri/map', 'esri/layers/FeatureLayer', 'plugins/smartMapping', 'dojo/domReady!'], function(Map) {\n          dfd.resolve();\n        });\n        App.reqres.setHandler('smaps:update:style', this.updateStyle);\n      },\n\n      onBeforeDestroy: function () {\n        if (this.map) {\n          this.map.destroy();\n        }\n      },\n\n      proxyEvent: function (evtName, evt) {\n        this.globalChannel.vent.trigger(evtName, evt);\n        //OR (if everything that will listen has a reference to this)\n        //this.trigger(evtName, evt);\n      },\n\n      createMap: function (mapDiv, options) {\n        var mapOpts = {\n          center: [ -56.049, 38.485 ],\n          zoom: 3,\n          basemap: 'dark-gray'\n        };\n\n        this.map = new esri.Map(mapDiv, mapOpts);\n\n        if (options.coords) {\n          var extent = new esri.geometry.Extent(options.coords[0][0], options.coords[0][1], options.coords[1][0], options.coords[1][1], new esri.SpatialReference({ wkid: 4326 }));\n          this.map.setExtent(extent);\n        }\n\n        //proxy events\n        this.map.on('load', dojo.hitch(this, this.proxyEvent, 'map:load'));\n        this.map.on('extent-change', dojo.hitch(this, this.proxyEvent, 'map:extent-change'));\n        this.map.on('layer-add', dojo.hitch(this, this.proxyEvent, 'map:layer-add'));\n      },\n\n      getDatasetInfoTemplate: function (dataset) {\n        //var datasetName = dataset.get('name');\n        var displayFieldName = dataset.get('display_field');\n        return new esri.InfoTemplate('${' + displayFieldName + '}', '${*}');\n      },\n\n      getDatasetLayerOpts: function (dataset) {\n        return { \n          mode: esri.layers.FeatureLayer.MODE_AUTO,\n          outFields: '*',\n          infoTemplate: this.getDatasetInfoTemplate(dataset)\n        };\n      },\n\n      addDataset: function (dataset) {\n        var opts = this.getDatasetLayerOpts(dataset);\n        this.datasetLayer = new esri.layers.FeatureLayer(dataset.get('url'), opts);\n\n        this.datasetLayer.on('load', this.onLoadDataset);\n\n        //proxy events\n        this.datasetLayer.on('load', dojo.hitch(this, this.proxyEvent, 'map:datasetlayer:load'));\n        this.datasetLayer.on('click', dojo.hitch(this, this.proxyEvent, 'map:datasetlayer:click'));\n        this.datasetLayer.on('query-limit-exceeded', dojo.hitch(this, this.proxyEvent, 'map:datasetlayer:query-limit-exceeded'));\n        this.datasetLayer.on('update-end', dojo.hitch(this, this.proxyEvent, 'map:datasetlayer:update-end'));\n\n        this.map.addLayer(this.datasetLayer);\n      },\n\n      onLoadDataset: function (evt) {\n        //squash scale ranges - we need the layer to draw at all scales\n        evt.layer.minScale = 0; \n        evt.layer.maxScale = 0;\n      },\n\n      updateStyle: function (opts) {\n        var dfd = $.Deferred();\n\n        var layer = opts.layer = this.datasetLayer;\n\n        var _applyRenderer = function(smap){\n          layer.setRenderer(smap.renderer);\n\n          //check if refresh needed, else redraw\n          if ( layer.graphics && layer.graphics.length ) {\n            if (layer.graphics[0].attributes[ opts.field ]) {\n              layer.redraw();\n            } else {\n              layer.refresh();\n            }\n          }\n\n          dfd.resolve(smap.renderer);\n        };\n\n          \n        if (opts.type === 'polygon'){\n          esri.renderer.smartMapping.createClassedColorRenderer(opts)\n            .then(function(renderer){\n              _applyRenderer( renderer );\n            });\n        } else if (opts.type === 'point' && !opts.heatmap){\n          esri.renderer.smartMapping.createClassedSizeRenderer(opts)\n            .then(function(renderer){\n              _applyRenderer( renderer );\n            });\n        } else if (opts.type === 'point' && opts.heatmap) {\n          esri.renderer.smartMapping.createHeatmapRenderer(opts)\n            .then(function(renderer){\n              _applyRenderer( renderer );\n            });\n        }\n\n        return dfd.promise();\n      }\n      \n    });\n\n  });\n})();\n\n(function () {\n\n  'use strict';\n    \n  MyOD.module('Base', function (Base, App, Backbone, Marionette, $, _) {\n\n    Base.SearchView = Marionette.ItemView.extend({ \n\n      onRender: function(){\n        this.initTypeahead();\n      },\n\n      initTypeahead: function () {\n        var self = this;\n\n        var opts = {\n          highlight: true,\n          minLength: 3,\n          hint: false\n        };\n\n        var bloodhound = App.getBloodhound();\n        bloodhound.initialize();\n\n        var datasets = {\n          name: 'datasets',\n          displayKey: function(item) {\n            return item;\n          },\n          templates: {\n            empty: ''\n          },\n          source: bloodhound.ttAdapter()\n        };\n\n        this.ui.search.typeahead(opts, datasets);\n      },\n\n      onTypeaheadSelected: function (e) {\n        //clicking a selection with the mouse should initiate a search  \n        this.model.set({\n          q: this.ui.search.typeahead('val'),\n          page: 1\n        });\n\n        this.search();\n      },\n\n      updateModel: function () {\n        var q = this.ui.search.typeahead('val');\n        this.model.set({\n          q: q,\n          page: 1\n        });\n      },\n\n      onKeyDown:function(e){\n        if (e.which === 13) {\n          e.preventDefault();\n\n          this.updateModel();\n\n          this.search();\n        }\n      },\n\n      onKeyUp: function () {\n        this.updateModel();\n      },\n\n      search: function () {\n        App.search();\n      }\n\n    });\n\n  });\n\n})();\n\n\n(function () {\n\n  'use strict';\n    \n  MyOD.module('Models', function (Models, App, Backbone, Marionette, $, _) {\n          \n    Models.SearchModel = Backbone.Model.extend({ \n\n      defaults: {\n        q: '',\n        page: 1,\n        per_page: 20,\n        total_count: 0,\n        sort_by: 'relevance'\n      },\n\n      queryStringParams: [ 'q', 'page', 'per_page', 'sort_by' ],\n\n      getRoute: function (api) {\n        var obj = _.pick(this.toJSON(), this.queryStringParams);\n        var route = 'datasets';\n        route += (api) ? '.json?' : '?';\n        route += $.param(obj);\n        return route;\n      },\n\n      getUrl: function () {\n        return App.config.api + this.getRoute(true);\n      }\n\n    });\n\n  });\n\n})();\n\nMyOD.config = {\n  //api: '//umb.dcdev.opendata.arcgis.com/'\n  //api: '//data3.dc.opendataqa.arcgis.com/'\n  //api: '//umb.dcdev.staging.datacommunity.io/'\n  api: '//opendata.arcgis.com/'\n};\n\n(function () {\n\n  'use strict';\n    \n  MyOD.module('Main', function (Main, App, Backbone, Marionette, $, _) {\n          \n    Main.HeaderSearchView = MyOD.Base.SearchView.extend({ \n\n      initialize: function () {\n        this.listenTo(this.model, 'change:q', this.onQueryChanged);\n      },\n\n      el: '#header-search-container',\n\n      template: false,\n\n      events: {\n        'keydown #header-search': 'onKeyDown',\n        'keyup #header-search': 'onKeyUp',\n        'click #header-search-btn': 'search',\n        'typeahead:selected input': 'onTypeaheadSelected'\n      },\n\n      ui: {\n        search: '#header-search'\n      },\n\n      onQueryChanged: function () {\n        this.ui.search.typeahead('val', this.model.get('q'));\n      }\n\n    });\n\n  });\n\n})();\n\n\n(function () {\n\n  'use strict';\n    \n  MyOD.module('Main', function (Main, App, Backbone, Marionette, $, _) {\n\n    Main.Layout = Marionette.LayoutView.extend({\n      \n      initialize: function () {\n        _.bindAll(this, 'setClasses');\n        this.headerSearchView = new Main.HeaderSearchView({ model: App.searchModel }).render();\n      },\n\n      el: 'body',\n\n      regions: {\n        main: '#main-region'\n      },\n\n      events: {\n        'click #home-link': 'navigateHome'\n      },\n\n      navigateHome: function (e) {\n        if (!e.metaKey && !e.ctrlKey) {\n          e.preventDefault();\n          App.navigate('', { trigger: true });\n        }\n      },\n\n      setClasses: function () {\n        var self = this;\n        if (Backbone.history.getFragment().indexOf('datasets') === 0) {\n          self.$el.removeClass('page-home');\n        } else {\n          self.$el.addClass('page-home');\n        }\n      }\n\n    });\n\n  });\n\n})();\n\n\n(function () {\n\n  'use strict';\n    \n  MyOD.module('HomeModule', function (HomeModule, App, Backbone, Marionette, $, _) {\n          \n    HomeModule.View = MyOD.Base.SearchView.extend({ \n\n      initialize: function () {\n        this.model = App.searchModel;   \n      },\n\n      template: JST['home/templates/home'],\n\n      events: {\n        'keydown #search': 'onKeyDown',\n        'keyup #search': 'onKeyUp',\n        'click #search-btn': 'search',\n        'typeahead:selected input': 'onTypeaheadSelected'\n      },\n\n      ui: {\n        search: '#search'\n      },\n\n      id: 'home',\n\n      onDomRefresh: function () {\n        this.ui.search.focus();\n      }\n\n    });\n\n  });\n\n})();\n\n\n(function () {\n\n  'use strict';\n    \n  MyOD.module('HomeModule', function (HomeModule, App, Backbone, Marionette, $, _) {\n          \n    HomeModule.Controller = Marionette.Controller.extend({ \n\n      initUi: function () {\n        var view = new HomeModule.View();\n        App.layout.getRegion('main').show(view);\n      }\n\n    });\n\n  });\n\n})();\n\n\n(function () {\n    \n  'use strict';\n\n  MyOD.module('HomeModule', function (HomeModule, App, Backbone, Marionette, $, _) {\n      \n    //Router for the module\n    HomeModule.Router = Backbone.Marionette.AppRouter.extend({\n      appRoutes:{\n        '': 'show'\n      }\n    });\n\n    //Add the router during the initialization \n    HomeModule.addInitializer(function (options) {\n      var router = new HomeModule.Router({ controller: HomeModule.API }); \n    });\n\n    //Simple API object that provides the implementation for the routes\n    HomeModule.API = {\n\n      show: function(options){\n\n        if(!this.homeController){\n          this.homeController = new HomeModule.Controller(options);\n        }\n\n        this.homeController.initUi(options);\n      }\n    };\n\n  });\n})();\n\n(function () {\n\n  'use strict';\n    \n  MyOD.module('Models', function (Models, App, Backbone, Marionette, $, _) {\n          \n    Models.DatasetModel = Backbone.Model.extend({\n\n      initialize: function () {\n        this.on('sync', this.onSync);\n      },\n\n      defaults: {\n        id: '',\n        name: '',\n        description: '',\n        tags: [],\n        arcgis_online_item_url: '',\n        owner: '',\n        url: '',\n        created_at: '',\n        updated_at: '',\n        views: 0,\n        thumbnail_url: ''\n      },\n\n      parse: function (response) {\n        var data = response.data || response;\n        return data;\n      },\n\n      url: function () {\n        return MyOD.config.api + 'datasets/' + this.get('id') + '.json';\n      },\n\n      getNumericFields: function () {\n        var fields = this.get('fields');\n        return _.filter(fields, function (item) {\n          return _.contains([ 'esriFieldTypeSingle', 'esriFieldTypeDouble', 'esriFieldTypeInteger' ], item.type);\n        });\n      }\n\n    });\n\n  });\n\n})();\n\n\n(function () {\n\n  'use strict';\n    \n  MyOD.module('Models', function (Models, App, Backbone, Marionette, $, _) {\n          \n    Models.DatasetCollection = Backbone.Collection.extend({\n\n      model: Models.DatasetModel,\n\n      url: function () {\n        return App.searchModel.getUrl(true);\n      },\n\n      parse: function (resp) {\n        App.searchModel.set(_.extend(resp.metadata.query_parameters, resp.metadata.stats));\n        return resp.data;\n      }\n\n    });\n\n  });\n\n})();\n\n\n(function () {\n\n  'use strict';\n    \n  MyOD.module('ResultsModule', function (ResultsModule, App, Backbone, Marionette, $, _) {\n\n    ResultsModule.ItemView = Marionette.ItemView.extend({ \n\n      template: JST['results/templates/results-item'],\n\n      model: MyOD.Models.DatasetModel,\n\n      tagName: 'tr',\n\n      events: {\n        click: 'onClick'\n      },\n\n      onClick: function () {\n        this.trigger('result:clicked', this.model);\n      }\n\n    });\n\n    ResultsModule.LoadingView = Marionette.ItemView.extend({ \n\n      template: JST['results/templates/results-loading'],\n\n      tagName: 'tr',\n\n      className: 'loading'\n\n    });\n\n    ResultsModule.EmptyView = Marionette.ItemView.extend({ \n\n      template: JST['results/templates/results-empty'],\n\n      tagName: 'tr'\n\n    });\n\n    ResultsModule.View = Marionette.CompositeView.extend({ \n\n      initialize: function () {\n        this.listenTo(this, 'childview:result:clicked', this.selectDataset);\n      },\n\n      collectionIsLoading: true,\n\n      template: JST['results/templates/results'],\n\n      childView: ResultsModule.ItemView,\n\n      childViewContainer: 'tbody',\n\n      getEmptyView: function () {\n        if (this.collectionIsLoading) {\n          return ResultsModule.LoadingView;\n        } else {\n          return ResultsModule.EmptyView;\n        }\n      },\n\n      events: {\n        'click ul.pagination a': 'onPageClicked'\n      },\n\n      modelEvents: {\n        'change:total_count': 'render'\n      },\n\n      collectionEvents: {\n        'sync': 'onCollectionSync',\n        'error': 'onCollectionSync'\n      },\n\n      id: 'page-results',\n\n      onCollectionSync: function () {\n        this.collectionIsLoading = false;\n        this.render();\n      },\n\n      selectDataset: function (childView, childModel) {\n        App.navigate('/datasets/' + childModel.get('id'), { trigger: true });\n      },\n\n      onPageClicked: function (e) {\n        //allow cmd-click to open in new window\n        if(!(e.metaKey || e.ctrlKey)){\n          e.stopPropagation();\n          e.preventDefault();\n          var page = $(e.target).closest('a').data('page');\n          //not sure why i was doing it this way...\n          //var model = App.searchModel.clone();\n          //App.navigate(model.getRoute(false), { trigger: true });\n          this.model.set('page', page);\n          App.search();\n        }\n      },\n\n      templateHelpers: function () {\n        //serialize the model into what we need for the template\n        var info = App.searchModel.toJSON();\n\n        var len = Math.round(info.total_count);\n        var page = +info.page;\n        var from = (page === 0) ? page + 1 : page;\n        var size = info.per_page;\n        var total_pages = Math.ceil(len / size);\n        var pages = [];\n        \n        //don't show more than 10?\n        var start = ( total_pages > 10 && from > 6 ) ? from - 5 : 1;\n        var end = ( total_pages > start + 9 ) ? start + 9 : total_pages;\n\n        // build the pages array\n        var searchModel = this.model.clone();\n        var active;\n        for (var i = start; i <= end; i++) {\n          active = (i === from) ? 'active' : '';\n          searchModel.set('page', i);\n          pages.push({ url: searchModel.getRoute(false), page: i, active: active });\n        }\n\n        var prevUrl = this.model.getRoute(false);\n        var prevPage = page;\n        if (from !== 1) { \n          prevPage = page-1;\n          searchModel.set('page', prevPage);\n          prevUrl = searchModel.getUrl();\n        }\n        var nextUrl = this.model.getRoute(false);\n        var nextPage = page;\n        if (total_pages !== from) {\n          nextPage = page + 1;\n          searchModel.set('page', nextPage);\n          nextUrl = searchModel.getUrl();\n        }\n\n        return {\n          firstPage: (from === 1) ? 'disabled' : '',\n          lastPage: (total_pages === from) ? 'disabled' : '',\n          prevUrl: prevUrl,\n          nextUrl: nextUrl,\n          prevPage: prevPage,\n          nextPage: nextPage,\n          pages: pages,\n          collectionIsLoading: this.collectionIsLoading\n        };\n      }\n\n    });\n\n  });\n\n})();\n\n\n(function () {\n\n  'use strict';\n    \n  MyOD.module('ResultsModule', function (ResultsModule, App, Backbone, Marionette, $, _) {\n          \n    ResultsModule.Controller = Marionette.Controller.extend({ \n\n      initUi: function (options) {\n        this.collection = new App.Models.DatasetCollection();\n        this.collection.fetch({ cache: true });\n        this.view = new ResultsModule.View({ model: App.searchModel, collection: this.collection });\n        App.layout.getRegion('main').show(this.view);\n      }\n\n    });\n\n  });\n\n})();\n\n\n(function () {\n    \n  'use strict';\n\n  MyOD.module('ResultsModule', function (ResultsModule, App, Backbone, Marionette, $, _) {\n      \n    //Router for the module\n    ResultsModule.Router = Backbone.Marionette.AppRouter.extend({\n      appRoutes:{\n        'datasets(/)': 'show'\n      }\n    });\n\n    //Add the router during the initialization \n    ResultsModule.addInitializer(function (options) {\n      var router = new ResultsModule.Router({ controller: ResultsModule.API }); \n    });\n\n    //Simple API object that provides the implementation for the routes\n    ResultsModule.API = {\n\n      show: function(options){\n\n        var queryObj = App.queryStringToObject();\n        //don't encode the q\n        // var q = App.searchModel.get('q');\n        // App.searchModel.set(_.extend(queryObj, { q: q }));\n        App.searchModel.set(queryObj);\n\n        if(!this.resultsController){\n          this.resultsController = new ResultsModule.Controller(options);\n        }\n\n        this.resultsController.initUi(options);\n      }\n\n    };\n\n  });\n})();\n\n(function () {\n\n  'use strict';\n    \n  MyOD.module('Models', function (Models, App, Backbone, Marionette, $, _) {\n          \n    Models.DatasetRow = Backbone.Model.extend({\n\n      \n\n    });\n\n  });\n\n})();\n\n\n(function () {\n\n  'use strict';\n    \n  MyOD.module('Models', function (Models, App, Backbone, Marionette, $, _) {\n          \n    Models.RowCollection = Backbone.Collection.extend({\n\n      initialize: function (attributes, options) {\n        this.dataset = options.dataset;\n        \n        var queryCapabilities = this.dataset.get('advanced_query_capabilities');\n        //TODO: this is wrong - it should be supports_pagination but they changed the api!\n        this.supportsPagination = queryCapabilities && queryCapabilities.supportsPagination;\n        \n        if (queryCapabilities && !_.isUndefined(queryCapabilities.supports_pagination)) { \n          window.alert('The API has been fixed. Time to update /entities/row-collection.js!');\n        }\n\n        this.orderBy = this.dataset.get('object_id_field');\n      },\n\n      perPage: 10,\n\n      page: 0,\n\n      orderBy: '',\n\n      orderByAsc: true,\n\n      model: Models.DatasetRow,\n\n      getQueryUrl: function () {\n        var url = this.dataset.get('url');\n        url += '/query?where=1%3D1&text=&objectIds=&time=&geometry=&geometryType=esriGeometryEnvelope&inSR=&spatialRel=esriSpatialRelIntersects&relationParam=&outFields=*&returnGeometry=false&maxAllowableOffset=&geometryPrecision=&outSR=&returnIdsOnly=false&returnCountOnly=false&groupByFieldsForStatistics=&outStatistics=&returnZ=false&returnM=false&gdbVersion=&returnDistinctValues=false&f=pjson';\n\n        if (this.supportsPagination) {\n          url += '&resultOffset=' + this.page * this.perPage;\n          url += '&resultRecordCount=' + this.perPage;\n          //NOTE: when you pass in one of the above two parameters and orderByFields is left empty, \n          //map service uses the object-id field to sort the result. \n          //For a query layer with a pseudo column as the object-id field (e.g., FID), \n          //you must provide orderByFields; otherwise the query fails\n        }\n\n        var orderBy = this.orderBy;\n        if (!this.orderByAsc) {\n          orderBy += ' desc';\n        }\n        //NOTE: this still could fail \n        //if the oid field has changed since it was harvested by open data\n        //or it is null (which should not happen...)\n        url += '&orderByFields=' + orderBy;\n\n        return url;\n      },\n\n      url: function () {\n        return this.getQueryUrl();\n      },\n\n      parse: function (resp) {\n        // this.fields = resp.fields;\n        // this.fieldAliases = resp.fieldAliases;\n        var rows = resp.features;\n        if (!this.supportsPagination) {\n          //this is slightly crappy but \n          //for datasets that don't support pagination\n          //we just show the first n rows with no pagination\n          //even though we got maxRecordCount rows\n          rows = _.first(rows, this.perPage);\n        }\n        return rows;\n      }\n\n    });\n\n  });\n\n})();\n\n\n(function () {\n\n  'use strict';\n    \n  MyOD.module('DatasetsModule', function (DatasetsModule, App, Backbone, Marionette, $, _) {\n         \n    DatasetsModule.TableRowView = Marionette.ItemView.extend({ \n\n      initialize: function (options) {\n        this.dataset = options.dataset;\n        this.fields = this.dataset.get('fields');\n      },\n\n      template: JST['datasets/templates/table-row'],\n\n      templateHelpers: function () {\n        var self = this;\n        return {\n          fields: self.fields\n        };\n      },\n\n      model: MyOD.Models.DatasetRow,\n\n      tagName: 'tr'\n\n    });\n\n    DatasetsModule.TableView = Marionette.CompositeView.extend({\n\n      initialize: function (options) {\n        this.collection = new App.Models.RowCollection([], { dataset: this.model });\n        this.collection.fetch();\n      },\n\n      events: {\n        'click ul.pagination li a': 'onPageClicked',\n        'click thead th': 'sort'\n      },\n\n      collectionEvents: {\n        //we need the pagination to re-render\n        'reset': 'render'\n      },\n\n      template: JST['datasets/templates/table'],\n\n      childView: DatasetsModule.TableRowView,\n\n      childViewOptions: function () {\n        var dataset = this.model;\n        return {\n          dataset: dataset\n        };\n      },\n\n      templateHelpers: function () {\n\n        //defaults - this is what will be rendered if the dataset does not support pagination\n        var obj = {\n          firstPage: '',\n          lastPage: '',\n          prevPage: 0,\n          nextPage: 0,\n          pages: [],\n          showPagination: false,\n          from: 1,\n          to: this.collection.perPage,\n          total: this.model.get('record_count'),\n          sortField: this.collection.orderBy,\n          sortClass: this.collection.orderByAsc ? 'sort_asc' : 'sort_desc',\n          sortIconClass: this.collection.orderByAsc ? 'glyphicon-arrow-down' : 'glyphicon-arrow-up',\n        };\n\n        if (this.collection.supportsPagination) {\n          var totalPages = Math.ceil(this.model.get('record_count') / this.collection.perPage);\n          //zero based page index\n          var page = this.collection.page;\n\n          //don't show more than 10 pages in paginator?\n          var start = (totalPages > 10 && page > 6) ? page - 5 : 1;\n          var end = (totalPages > start + 9) ? start + 9 : totalPages;\n\n          var active, pages = [];\n          for (var i = start; i <= end; i++) {\n            active = (i === page + 1) ? 'active' : '';\n            pages.push({ page: i, active: active });\n          }\n\n          var total = this.model.get('record_count');\n          var from = page * this.collection.perPage + 1;\n          var to = page * this.collection.perPage + this.collection.perPage;\n          to = (to <= total) ? to : total;\n\n          obj = {\n            firstPage: (page === 0) ? 'disabled' : '',\n            lastPage: (totalPages === page + 1) ? 'disabled' : '',\n            prevPage: page,\n            nextPage: page + 2,\n            pages: pages,\n            showPagination: true,\n            from: from,\n            to: to,\n            total: total,\n            sortField: this.collection.orderBy,\n            sortClass: this.collection.orderByAsc ? 'sort_asc' : 'sort_desc',\n            sortIconClass: this.collection.orderByAsc ? 'glyphicon-chevron-down' : 'glyphicon-chevron-up',\n          };\n        }\n\n        return obj;\n      },\n\n      childViewContainer: 'tbody',\n\n      onPageClicked: function (e) {\n        var anchor = $(e.target).closest('a');\n        var li = anchor.closest('li');\n        if (!li.hasClass('disabled') && !li.hasClass('active')) {\n          var page = anchor.data('page') - 1;\n          this.collection.page = page;\n          this.collection.fetch({ reset: true });\n        }\n      },\n\n      sort: function (e) {\n        var orderBy = $(e.target).data('fieldName');\n        if (orderBy) {\n          if (orderBy === this.collection.orderBy) {\n            this.collection.orderByAsc = !this.collection.orderByAsc;\n          } else {\n            this.collection.orderByAsc = true;\n          }\n          this.collection.page = 0;\n          this.collection.orderBy = orderBy;\n          this.collection.fetch({ reset: true });\n        }\n      }\n      \n    });\n\n  });\n\n})();\n\n\n(function () {\n\n  'use strict';\n    \n  MyOD.module('DatasetsModule', function (DatasetsModule, App, Backbone, Marionette, $, _) {\n          \n    DatasetsModule.View = Marionette.ItemView.extend({\n\n      initialize: function (options) {\n        _.bindAll(this, 'changeAttribute', 'changeRamp');\n        this.mapManager = options.mapManager;\n      },\n\n      template: JST['datasets/templates/dataset'],\n\n      id: 'page-dataset',\n\n      ui: {\n        'mapDiv': '#map',\n        'tableContainer': '#table-container'\n      },\n\n      modelEvents: {\n        'change': 'render'\n      },\n\n      templateHelpers: function () {\n        var baseUrl = this.model.url().replace(/.json$/, '');\n        return {\n          baseUrl: baseUrl \n        };\n      },\n\n      onRender: function () {\n        //TODO: refactor to use regions...\n        this.tableView = new DatasetsModule.TableView({ el: this.ui.tableContainer, model: this.model }).render();\n      },\n\n      // onShow: function () {\n      //   console.debug('onShow');\n      // },\n\n      onDomRefresh: function () {\n        if (this.model.get('layer_type').toLowerCase() !== 'table') {\n          var self = this;\n          // TODO: would be nice to encapsulate this in mapmanager so consumers wouldn't have to know to do it\n          this.ui.mapDiv.show();\n          this.mapManager.dojoReady.done(function () {\n            self.mapManager.createMap('map', { coords: self.model.get('extent').coordinates });\n            self.mapManager.addDataset(self.model);\n\n            self.initSmaps();\n          });\n        }\n      },\n\n      initSmaps: function (basemap) {\n        var numerics = this.model.getNumericFields();\n\n        if (numerics.length){\n\n          // select the first attr to map \n          // we could put some logic around which to use here\n          this.fieldName = this.fieldName || numerics[0].name;\n          \n          //get stats for selected attribute\n          var fields = this.model.get('fields');\n          this.stats = this.getStats(fields, this.fieldName);\n          this.type = this.getGeometryType(this.model.get('geometry_type'));\n\n\n          var yukiOptions = {\n            fields: numerics,\n            field: this.fieldName,\n            statistics: this.stats,\n            type: this.type,\n            schemes: this.getSchemes()\n          };\n\n          if (!this.yuki) {\n            this.yuki = new Yuki('smaps', yukiOptions);\n          } else {\n            $('#yuki-viz-tools').remove();\n            this.yuki = new Yuki('smaps', yukiOptions);\n          }\n\n          // EVENT Handlers from yuki\n          this.yuki.on('change', this.changeAttribute);\n          this.yuki.on('ramp-change', this.changeRamp);\n\n          this._execStyleMap();\n        }\n\n      },\n\n      getStats: function (fields, fieldName) {\n        var fieldObj = _.findWhere(fields, { name: fieldName });\n        return fieldObj ? fieldObj.statistics : null;\n      },\n\n      getGeometryType: function (geomType) {\n        switch (geomType) {\n          case 'esriGeometryPoint':\n          case 'esriGeometryMultipoint':\n            return 'point';\n          case 'esriGeometryPolyline':\n            return 'line';\n          case 'esriGeometryPolygon':\n            return 'polygon';\n          default:\n            return geomType.toLowerCase();\n        }\n      },\n\n      getSchemes: function (){\n        var theme, styleType, self = this;\n        switch (this.type){\n          case 'point':\n            theme = 'default';\n            styleType = 'size';\n            break;\n          case 'polygon':\n            theme = 'high-to-low';\n            styleType = 'choropleth';\n            break;\n        }\n\n        //TODO: move this into mapmanager\n        return esri.styles[styleType].getSchemes({\n          theme: theme, \n          basemap: 'dark-gray', \n          geometryType: self.type\n        });\n      },\n\n      // handler for attr change \n      changeAttribute: function (fieldName) {\n        //update stats for selected attribute\n        var fields = this.model.get('fields');\n        this.stats = this.getStats(fields, fieldName);\n        this.fieldName = fieldName;\n\n        this._execStyleMap(this.selectedScheme);\n      },\n\n      // handler for ramp UI change\n      changeRamp: function (index) {\n        this.selectedScheme = this.getSchemes().secondarySchemes[index];\n        this._execStyleMap(this.selectedScheme);\n      },\n\n      //update the map in mapmanager\n      _execStyleMap: function (scheme) {\n        var self = this;\n\n        var opts = {\n          field: this.fieldName,\n          basemap: 'dark-gray',\n          statistics: this.stats,\n          type: this.type\n        };\n      \n        if (scheme){\n          opts.scheme = scheme;\n        }\n        \n        var foo = App.reqres.request('smaps:update:style', opts)\n          .done(function(renderer){\n            if (self.type === 'point'){\n              self.yuki.buildPointLegend(renderer.breaks);\n            }\n          });\n      },\n\n      onDestroy: function () {\n        this.mapManager.destroy();\n        this.tableView.destroy();\n      }\n      \n    });\n\n  });\n\n})();\n\n\n(function () {\n\n  'use strict';\n    \n  MyOD.module('DatasetsModule', function (DatasetsModule, App, Backbone, Marionette, $, _) {\n\n    DatasetsModule.Controller = Marionette.Controller.extend({ \n\n      initialize: function () {\n        _.bindAll(this, 'onModelFetched');\n      },\n\n      initUi: function (options) {\n        this.mapManager = new App.Utils.MapManager();\n        this.model = new App.Models.DatasetModel({ id: options });\n        this.model\n          .fetch()\n            .done(this.onModelFetched)\n            .fail(function () {\n              App.navigate404();\n            });\n      },\n\n      onModelFetched: function () {\n        var view = new DatasetsModule.View({ model: this.model, mapManager: this.mapManager });\n        App.layout.getRegion('main').show(view);\n      },\n\n      onBeforeDestroy: function () {\n        if (this.mapManager) {\n          this.mapManager.destroy();\n        }\n      }\n\n    });\n\n  });\n\n})();\n\n\n(function () {\n    \n  'use strict';\n\n  MyOD.module('DatasetsModule', function (DatasetsModule, App, Backbone, Marionette, $, _) {\n      \n    //Router for the module\n    DatasetsModule.Router = Backbone.Marionette.AppRouter.extend({\n      appRoutes:{\n        'datasets/:id(/)': 'show',\n      }\n    });\n\n    //Add the router during the initialization \n    DatasetsModule.addInitializer(function (options) {\n      var router = new DatasetsModule.Router({ controller: DatasetsModule.API }); \n    });\n\n    //Simple API object that provides the implementation for the routes\n    DatasetsModule.API = {\n\n      show: function(options){\n\n        if(!this.datasetsController){\n          this.datasetsController = new DatasetsModule.Controller(options);\n        }\n\n        this.datasetsController.initUi(options);\n      }\n    };\n\n  });\n})();\n\n(function () {\n\n  'use strict';\n    \n  MyOD.module('ErrorModule', function (ErrorModule, App, Backbone, Marionette, $, _) {\n          \n    ErrorModule.View = Marionette.ItemView.extend({\n      \n      id: 'page-error',\n\n      getTemplate: function(){\n        var errorCode = this.model.get('errorCode');\n        var template;\n\n        switch (errorCode) {\n          case 404:\n              template = JST['error/templates/404'];\n            break;\n          default:\n              template = JST['error/templates/500'];\n        }\n\n        return template;\n      }\n\n    });\n\n  });\n\n})();\n\n\n(function () {\n\n  'use strict';\n    \n  MyOD.module('ErrorModule', function (ErrorModule, App, Backbone, Marionette, $, _) {\n\n    ErrorModule.Controller = Marionette.Controller.extend({ \n\n      initUi: function (options) {\n        // init the results view in here so it re-binds on \"back button\"\n        var model = new Backbone.Model({ errorCode: options.errorCode });\n        var view = new ErrorModule.View({ model: model });\n\n        App.layout.getRegion('main').show(view);\n      }\n\n    });\n\n  });\n\n})();\n\n\n(function () {\n    \n  'use strict';\n\n  MyOD.module('ErrorModule', function (ErrorModule, App, Backbone, Marionette, $, _) {\n      \n    //Router for the module\n    ErrorModule.Router = Backbone.Marionette.AppRouter.extend({\n      appRoutes:{\n        '404': 'error404',\n        '500': 'error500'\n      }\n    });\n\n    //Add the router during the initialization \n    ErrorModule.addInitializer(function (options) {\n      var router = new ErrorModule.Router({ controller: ErrorModule.API }); \n    });\n\n    //Simple API object that provides the implementation for the routes\n    ErrorModule.API = {\n\n      initController: function () {\n        if(!this.errorController){\n          this.errorController = new ErrorModule.Controller();\n        }\n      },\n\n      error404: function () {\n        this.initController();\n        this.errorController.initUi({ errorCode: 404 });\n      },\n\n      error500: function () {\n        this.initController();\n        this.errorController.initUi({ errorCode: 500 });\n      }\n    };\n\n  });\n})();\n\n$(function () {\n  'use strict';\n\n  MyOD.start();\n});"],"sourceRoot":"/source/"}